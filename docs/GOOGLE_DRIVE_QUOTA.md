# Решение проблемы квоты Google Drive

## Проблема

При создании файлов в Google Drive через сервисный аккаунт может возникнуть ошибка:
```
storageQuotaExceeded: The user's Drive storage quota has been exceeded.
```

## Причина

**Сервисные аккаунты Google имеют квоту хранилища 15 GB** (как обычные аккаунты). Когда эта квота превышена, нельзя создавать новые файлы.

## Решения

### Решение 1: Автоматическая передача ownership (Рекомендуется) ✅

**Система автоматически передаёт ownership всех создаваемых файлов указанному пользователю!**

Просто добавьте переменную окружения:
```env
GOOGLE_DRIVE_OWNER_EMAIL=your-email@domain.com
```

**Как это работает:**
- При создании файлов/папок/таблиц система автоматически передаёт их ownership указанному пользователю
- Файлы будут использовать квоту пользователя, а не сервисного аккаунта
- Не нужно вручную заходить в каждый аккаунт и удалять файлы

**Настройка:**
1. Укажите email пользователя с достаточной квотой (например, ваш корпоративный аккаунт)
2. Система автоматически передаст ownership всех новых файлов этому пользователю
3. Старые файлы можно передать вручную или оставить как есть

### Решение 2: Использовать Domain-Wide Delegation

Сервисный аккаунт может работать **от имени пользователя** с большей квотой (например, корпоративный аккаунт Google Workspace).

**Настройка:**

1. В Google Cloud Console включите Domain-Wide Delegation для сервисного аккаунта
2. Добавьте переменную окружения с email пользователя:
   ```env
   GOOGLE_IMPERSONATE_USER=your-email@domain.com
   ```
3. Обновите код для использования impersonation при создании файлов

**Преимущества:**
- Используется квота пользователя (может быть больше 15 GB)
- Файлы создаются от имени пользователя
- Больше контроля над файлами

### Решение 2: Очистить место в Drive сервисного аккаунта

1. Откройте Google Drive сервисного аккаунта (через email из credentials)
2. Удалите ненужные файлы
3. Очистите корзину

**Как найти email сервисного аккаунта:**
- В файле credentials JSON есть поле `client_email`
- Например: `best-pr-system@project-id.iam.gserviceaccount.com`

### Решение 3: Создать таблицу вручную

1. Создайте таблицу "BEST PR System - Таймлайны" вручную в Google Drive
2. Получите ID таблицы из URL: `https://docs.google.com/spreadsheets/d/{ID}/edit`
3. Укажите ID в переменных окружения:
   ```env
   GOOGLE_TIMELINE_SHEETS_ID=ваш_id_таблицы
   ```

### Решение 4: Использовать другой сервисный аккаунт

Создайте новый сервисный аккаунт с чистой квотой и используйте его credentials.

## Проверка использования квоты

К сожалению, Google API не предоставляет прямой способ проверить использование квоты сервисного аккаунта через API. Нужно:

1. Войти в Google Drive от имени сервисного аккаунта (если есть доступ)
2. Или проверить через Google Cloud Console → IAM → Service Accounts

## Рекомендации

1. **Используйте Domain-Wide Delegation** для работы от имени пользователя с достаточной квотой
2. **Регулярно очищайте** старые файлы из Drive сервисного аккаунта
3. **Мониторьте использование** через логи системы
4. **Используйте общие папки** - файлы в общих папках не занимают место у каждого пользователя

## Текущая реализация

Система обрабатывает ошибку квоты gracefully:
- Логирует предупреждение
- Продолжает работу без таблицы таймлайна
- Таблицу можно создать позже через API или вручную
