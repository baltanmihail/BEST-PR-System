# Интеграция с Google Таблицей учёта оборудки — документация для переноса

Документ описывает зависимости, структуру данных и принципы работы BEST Channel Bot с Google Sheets. Используйте его при переносе логики в новое приложение (сайт).

---

## 1. Зависимости Python

```
gspread>=5.12.0
google-auth>=2.23.0
google-auth-oauthlib>=1.1.0
google-auth-httplib2>=0.1.1
google-api-python-client>=2.100.0
```

**Импорты:**
```python
import gspread
from google.oauth2.service_account import Credentials
from googleapiclient.discovery import build
```

**Инициализация клиента:**
- Используется **Service Account** (сервисный аккаунт)
- JSON-ключ с credentials хранится в файле (например, `credentials.json`)
- Можно использовать несколько credentials для ротации и увеличения квоты API (см. `google_sheets.py`, строки 24-77)

---

## 2. Названия листов (вкладок) таблицы

| Лист | Назначение |
|------|------------|
| **Вся оборудка** | Справочник всего оборудования (номер, название, фото, статус) |
| **Учёт оборудки** | Альтернативное имя для того же листа (поддерживаются оба варианта) |
| **Заявки на оборудку** | Таблица заявок от пользователей |
| **Календарь занятости оборудования** | Цветной календарь с занятостью по датам |
| **История оборудки** | Архив завершённых выдач |

**Конфиг** — `config.py`, строки 35-38:
```python
SHEET_EQUIPMENT = "Вся оборудка"
SHEET_APPLICATIONS = "Заявки на оборудку"
SHEET_HISTORY = "История оборудки"
```

---

## 3. Лист «Вся оборудка» (справочник оборудования)

**Структура таблицы** — `google_sheets.py`, строки 526-551:

| Колонка (заголовок) | Описание | Индекс |
|---------------------|----------|--------|
| Номер | Номер единицы оборудования (1, 2, 3…) | 0 |
| Оборудование | Название | 1 |
| Фото | Ссылка/путь к фото (опционально) | 2 |
| Статус | «На складе», «В аренде» и т.д. | 3 |

**Код получения списка:**
- Метод `get_equipment_list()` — `google_sheets.py`, строки 454-577
- Возвращает список словарей: `[{'number': '1', 'name': 'Название', 'photo': '', 'status': 'На складе'}, ...]`
- Нужно получать формулы из столбца «Что берёт» через `value_render_option='FORMULA'`, если в заявках используется ссылка на этот лист

**Важно:** столбец C (Оборудование) используется в формулах заявок: `='Вся оборудка'!C{row_num}`.

---

## 4. Лист «Заявки на оборудку»

**Структура таблицы** — `google_sheets.py`, строки 1129-1146, 2941-2959:

| Колонка | Описание | Индекс |
|---------|----------|--------|
| Номер | Номер заявки (A) | 0 |
| Дата запроса | ДД.ММ.ГГГГ | 1 |
| Время обработки | Часто формула | 2 |
| Кто берёт | `https://t.me/username - ФИО` | 3 |
| Что берёт | Формула `='Вся оборудка'!C{row}` или название | 4 |
| Название мероприятия | Название съёмки | 5 |
| Дата выдачи | Дата получения (ДД.ММ.ГГГГ) | 6 |
| Дата съёмки | Дата съёмки (ДД.ММ.ГГГГ) | 7 |
| Дата возврата | Дата возврата (ДД.ММ.ГГГГ) | 8 |
| Комментарий | Текст | 9 |
| Статус | «На рассмотрении», «Одобрено», «Отклонено» | 10 |
| Причина отказа | При отклонении (если есть отдельная колонка) | — |

**Основные методы:**
- `submit_application()` — добавление заявки (`google_sheets.py`, 1057-1169)
- `update_application_status()` — смена статуса (`google_sheets.py`, 1340-…)
- `get_all_applications_with_status()` — все заявки с ключами по заголовкам (`google_sheets.py`, 2915-2975)

**Формула оборудования:**
- В «Что берёт» пишется формула `='Вся оборудка'!C{row_num}` (строка 1108)
- Для отображения названия формула парсится через `get_equipment_name_from_formula()` — строки 579-697

---

## 5. Лист «Календарь занятости оборудования»

### 5.1. Структура листа — `google_sheets.py`, строки 735-740, 2688-2757

| Строка | Содержимое | Индекс |
|--------|------------|--------|
| 1 | Период, напр. «Декабрь 2025 - Май 2026» | 0 |
| 2 | Числа дней (1, 2, 3… 31, 1, 2…) | 1 |
| 3 | Дни недели (Пн, Вт, Ср…) | 2 |
| 4 | Пустая | 3 |
| 5+ | Строки оборудования: A=номер, B+=номера заявок или пусто | 4+ |

**Столбцы:**
- A — номер оборудования
- B, C, D… — по одному дню периода
- В ячейке: номер заявки (если занято) или пусто

### 5.2. Чтение занятости — `get_booked_dates_from_calendar()`

**Файл:** `google_sheets.py`, строки 703-855.

**Алгоритм:**
1. Прочитать все значения: `calendar_ws.get_all_values()`.
2. Разобрать период из строки 1 (напр. «Декабрь 2025») — `month_names_ru`, regex `r'(\w+)\s+(\d{4})'` (строки 743-768).
3. Построить маппинг столбец → дата по строке 2 (числа дней): при уменьшении дня — переход на следующий месяц (строки 784-804).
4. Для каждой строки оборудования (с 5-й): собрать занятые даты по ячейкам с номерами заявок; промежутки между первой и последней ячейкой с одним номером тоже считаются занятыми (строки 834-855).

**Результат:** `{equipment_number: set(date, date, ...)}`.

### 5.3. Создание/обновление календаря — `create_or_update_calendar_sheet()`

**Файл:** `google_sheets.py`, строки 2242-2815.

**Этапы:**
1. Собрать бронирования из «Заявки на оборудку» (статусы «Одобрено», «На рассмотрении») — строки 2302-2536.
2. Добавить данные из «История оборудки» — строки 2557-2664.
3. Определить период: от минимальной до максимальной даты из всех бронирований + 5 месяцев вперёд — строки 2538-2703.
4. Заполнить строки оборудования: для каждой даты — номер заявки или пусто — строки 2727-2758.
5. Раскрасить ячейки через Sheets API (`batchUpdate`):
   - «На рассмотрении» — жёлтый `{red: 1, green: 1, blue: 0}`
   - «Одобрено» — красный `{red: 1, green: 0, blue: 0}`
   - «История» — серый `{red: 0.8, green: 0.8, blue: 0.8}`

**Код форматирования** — строки 2776-2820.

---

## 6. Лист «История оборудки»

**Назначение:** архив завершённых выдач.

**Ожидаемые колонки** (по использованию в коде):
- Статус
- Дата выдачи / Дата получения
- Дата возврата
- Оборудование / Номер оборудования

Используется для:
- учёта занятости при определении доступного оборудования (`get_available_equipment_for_dates`);
- добавления записей в календарь (серый цвет).

---

## 7. Кэширование и лимиты

**Кэш в `GoogleSheetsManager`** — `google_sheets.py`, строки 58-68:
- `equipment_list`: 180 с
- `calendar_bookings`: 120 с
- `applications`: 60 с
- и т.д.

**Rate limiting** — строки 71-107:
- ~30 запросов в минуту;
- минимальный интервал между запросами 2 с.

**Ротация клиентов:** при ошибке 429 (quota) переключается на следующий credentials из списка — строки 277-314.

---

## 8. Основные файлы и строки

| Что | Файл | Строки |
|-----|------|--------|
| Конфиг, листы, credentials | `config.py` | 29-56 |
| Класс менеджера, кэш, rate limit | `google_sheets.py` | 20-150 |
| Список оборудования | `google_sheets.py` | 454-577 |
| Название из формулы | `google_sheets.py` | 579-697 |
| Чтение занятости из календаря | `google_sheets.py` | 703-855 |
| Доступное оборудование по датам | `google_sheets.py` | ~900-1050 |
| Добавление заявки | `google_sheets.py` | 1057-1169 |
| Обновление статуса заявки | `google_sheets.py` | 1340-1450 |
| Создание/обновление календаря | `google_sheets.py` | 2242-2820 |
| Цвета ячеек календаря | `google_sheets.py` | 2776-2820 |
| Все заявки со статусами | `google_sheets.py` | 2915-2975 |
| DataManager (retry, кэш) | `data_manager.py` | 1-150 |

---

## 9. Форматы дат

- В таблице: `ДД.ММ.ГГГГ` (например, `22.12.2025`).
- Парсинг: `datetime.strptime(date_str, "%d.%m.%Y").date()`.
- Период в календаре: `"Декабрь 2025 - Май 2026"` (строка 1).

---

## 10. Рекомендации для веб-приложения

1. Использовать те же названия листов и структуру колонок.
2. Реализовать кэш на 1–3 минуты для списка оборудования и календаря.
3. Добавить rate limiting и retry при 429.
4. Для раскраски календаря вызывать `spreadsheets.batchUpdate` с `repeatCell`.
5. Период календаря вычислять от min/max дат всех заявок и истории.
6. Для «Что берёт» сохранять формулу `='Вся оборудка'!C{row}` при добавлении заявки.
